# インストールについて

prokishi エンジンは prokishi-server が起動してないと動作しない将棋エンジンです。
単独で動作するエンジンとは少し違うので注意してください。

またサーバを間違って外部に公開してしまうおそれもある為、ご注意ください。

## サーバ準備

prokishi-server を準備します。
起動を行うとexeがある位置にdbディレクトリが作成されます。

### エンジンの登録

利用したいエンジンのIDとパスを設定します。

> prokishi-server engine generate "エンジンの絶対パス"
> Generate EngineID-> 156506a3-4d27-49ee-a0aa-303c0cd99b61

登録が完了した場合、IDが表示されます。
自動設定のIDではなく、ご自身でIDを設定したい場合はregisterをご利用ください。

> prokishi-server engine register "mineid" "エンジンの絶対パス"

エンジンの絶対パスはスペースがある場合

> Please separate the engine paths with double quotes.

というエラーが発生します。
ダブルコーテーションで区切って登録してください。

### エンジンの確認

> prokishi-server engine 

とコマンドを打つと登録されているエンジンの一覧が表示されます。
IDと作成日、パスは改行されて表示されます。(2行で表示)

```
ID                                      |Created
----------------------------------------|-------------------------------------
ea2e9900-6d93-4118-afcd-ceb375e2e778    |2024-02-09 08:35:29.2225835 +0900 JST
D:\Program Files\shogi engine\YaneuraOu_NNUE-tournament-clang++-avx2.exe
・・・次のエンジンIDとパス
```

### エンジンの削除

利用しなくなったエンジンなどをIDを指定して削除します。

> prokishi-server engine delete {id}

### 認証コードの作成

もしプライベートではないネットワークにサーバを構築される場合、他人に利用される可能性があります。その時に認証をする為の機能で設定は必須ではありません。逆に1件でも設定を行うとクライアントに必ず設定を行う必要がありますので注意してください。

> prokishi-server code generate 

自動生成したくない場合はregisterで指定して作成します。

> prokishi-server code register {code} 

### 認証コードの確認

> prokishi-server code

### 認証コードの削除

> prokishi-server code delete {code}

## サーバの起動

> prokishi-server

起動が成功した場合、以下が出力されます。

> prokishi-server
> IP Address ====================
> fe80::f4db:ab6f:7fed:a0f4
> 192.168.11.32
> ===============================
> Listener Address: [::]:8080

IP Addressのどれかでアクセスできるようになるはずです。
この文字列をクライアントの設定ファイルに設定する必要があります。
※Listener Address はシステム的な値です

ここで設定したサーバのアドレスとポートはクライアントの設定ファイルに設定します。

## ポートが重複するエラー

prokishi-serverはデフォルトで8080ポートを利用しますが、同一のポートが利用されている場合は

```
listen tcp :8080: bind: Only one usage of each socket address (protocol/network address/port) is normally permitted.
```

と書かれたエラーが発生します。

デフォルトであるポートが使用されている為に起こるエラーです。
そういう場合は実行時に引数"-p"で設定を変更します。

> prokishi-server -p {任意の数値}

デフォルトのポートを利用したくない場合も利用してください。
どんな番号に設定してもポート番号が利用されている場合はこのエラーが発生します。
1024以上-65535以下を利用することが慣例となっています。

### ドメインやホスト名を利用したい場合

実行時に引数"-s"で指定します。

> prokishi-server -s example.com

この文字列を指定した場合、クライアントは名称でしかアクセスできなくなります。
クライアントがそのサーバ名でアクセスできる必要がある為、ネットワークに詳しい人以外は指定しないでください。


## クライアントの設定

クライアントの設定ファイルを設定します。

エンジンのexe(prokishi.exe)をおいたディレクトリにprokishi.iniを作成します。

```
host="localhost" <- サーバを起動しているアドレス
port=8080 <- 指定したポート番号(デフォルトで8080)
code="server code" <- 認証コードを発行した場合に指定
engineId="engine id" <- エンジンを設定したID
logLevel="warn" <- debugとするとUSIのやり取りまですべて記録します。
```

これらを設定して起動するとサーバ上での実行が可能になります。
※ポート以外の設定値は必ず""でくくってください。

## 複数のエンジンを動作させる場合

現状はエンジン側をコピーして設定ファイルで切り替えることで可能です。

設計思想では１エンジンで複数エンジンを選択できるようにしたかったのですが、どうしてもエンジン側に初期値として値を渡すことができず、設定ファイルによる実行になってしまいました。そのため、複数エンジンをサーバで動作させたい場合は、実行するディレクトリを分けて設定ファイルを編集して動作する必要があります。

### 起動時の動作

将棋エンジン的にはusiコマンドがきたときにoptionなどを返してあげる必要がありますが、起動時にサーバ等がわからない為、実際に動作するエンジンを決定できません。optionで設定したとしてもエンジン実行までsetoptionが来ない為、実際のエンジンのoptionを渡すことができない状況になりました。

他は起動パラメータで動作させることを考えましたが、ShogiGUIのエンジン登録がそれを許してないようなので断念しました。
